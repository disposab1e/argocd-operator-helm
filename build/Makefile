VERSION = 0.0.4
NAME = argocd-operator-helm

REGISTRY = quay.io
REGISTRY_DEV = imac.fritz.box:5000
REGISTRY_CI = docker.io
NAMESPACE=disposab1e

BUNDLE_MANIFEST_BASE_DIR = ../deploy/olm-catalog/
BUNDLE_DIR = bundle
BUNDLE_BUILD_BASE_DIR = _output/bundle
GUIDES_BUILD_BASE_DIR = _output/guides
QUICKSTARTS_BUILD_BASE_DIR = _output/quickstarts
GUIDES_BASE_DIR = ../guides
QUICKSTARTS_BASE_DIR = ../quickstarts


operator-build-ci:
	export GO111MODULE=on
	cd ../ && operator-sdk build ${REGISTRY_CI}/${NAMESPACE}/${NAME}:v${VERSION}
	
operator-push-ci:
	docker push ${REGISTRY_CI}/${NAMESPACE}/${NAME}:v${VERSION}

bundle-generate-k8s-ci: 
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/ci/k8s
	cp -r ${BUNDLE_DIR}/* ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests
	cp -r ${BUNDLE_MANIFEST_BASE_DIR}/k8s/${NAME} ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/
	sed 's/${REGISTRY_DEV}/${REGISTRY_CI}/g' ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY_CI}/g' ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml

bundle-verify-k8s-ci:
	operator-courier --verbose verify --ui_validate_io ${BUNDLE_BUILD_BASE_DIR}/ci/k8s/manifests/${NAME}

bundle-build-k8s-ci: 
	docker build -t ${REGISTRY_CI}/${NAMESPACE}/${NAME}-registry-k8s:${VERSION} ${BUNDLE_BUILD_BASE_DIR}/ci/k8s

bundle-push-k8s-ci:
	docker push ${REGISTRY_CI}/${NAMESPACE}/${NAME}-registry-k8s:${VERSION}

guide-generate-k8s-manual-ci:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	cp ../deploy/common/service-account.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	cp ../deploy/common/role.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	cp ../deploy/common/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	cp ../deploy/common/deployment.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual
	cp ../deploy/crds/argoproj.io_argocds_crd.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual/crd.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY_CI}/g' ../deploy/common/deployment.yaml > ${GUIDES_BUILD_BASE_DIR}/ci/k8s/manual/deployment.yaml

guide-generate-k8s-olm-ci:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm
	cp ../deploy/common/operator-group.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm
	cp ../deploy/k8s/catalog-source.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm
	cp ../deploy/k8s/subscription.yaml ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm
	sed 's/${REGISTRY_DEV}/${REGISTRY_CI}/g' ../deploy/k8s/catalog-source.yaml > ${GUIDES_BUILD_BASE_DIR}/ci/k8s/olm/catalog-source.yaml









bundle-generate-ocp-ci:
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/ci/ocp
	cp -r ${BUNDLE_DIR}/* ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests
	cp -r ${BUNDLE_MANIFEST_BASE_DIR}/ocp/${NAME} ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml

bundle-verify-ocp-ci:
	operator-courier --verbose verify --ui_validate_io ${BUNDLE_BUILD_BASE_DIR}/ci/ocp/manifests/${NAME}

bundle-build-ocp-ci: 
	docker build -t ${REGISTRY_CI}/${NAMESPACE}/${NAME}-registry-ocp:${VERSION} ${BUNDLE_BUILD_BASE_DIR}/ci/ocp

bundle-push-ocp-ci:
	docker push ${REGISTRY_CI}/${NAMESPACE}/${NAME}-registry-ocp:${VERSION}


guide-generate-ocp3-manual-ci:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	cp ../deploy/common/service-account.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	cp ../deploy/common/role.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	cp ../deploy/common/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	cp ../deploy/common/deployment.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual
	cp ../deploy/crds/argoproj.io_argocds_crd.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual/crd.yaml
	echo "---" >> ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual/role-binding.yaml
	cat ../deploy/ocp3/role-binding.yaml >> ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual/role-binding.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY_CI}/g' ../deploy/common/deployment.yaml > ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/manual/deployment.yaml

guide-generate-ocp3-olm-ci:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	cp ../deploy/common/operator-group.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	cp ../deploy/ocp3/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	cp ../deploy/ocp3/catalog-source.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	cp ../deploy/ocp3/subscription.yaml ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm
	sed 's/${REGISTRY_DEV}/${REGISTRY_CI}/g' ../deploy/ocp3/catalog-source.yaml > ${GUIDES_BUILD_BASE_DIR}/ci/ocp3/olm/catalog-source.yaml














clean:
	rm -rf _output

olm-deploy:
	curl -sL https://github.com/operator-framework/operator-lifecycle-manager/releases/download/0.13.0/install.sh | bash -s 0.13.0


argocd-deploy-ocp-oauth:
	oc apply -f ./../examples/ocp-oauth.yaml

argocd-deploy-ocp:
	oc apply -f ./../examples/ocp.yaml

argocd-deploy-k8s:
	oc apply -f ./../examples/k8s.yaml

argocd-deploy-k8s-lb:
	oc apply -f ./../examples/k8s-lb.yaml

argocd-undeploy-do-it-better:
	oc delete ArgoCD argocd -n argocd

helm-templates:
	helm lint ./../helm-charts/argo-cd/
	helm template --values ./../helm-charts/argo-cd/values.yaml  ./../helm-charts/argo-cd/
	helm template --values ./../examples/ocp-oauth.yaml ./../helm-charts/argo-cd 

docs-view:
	cd ../docs && make html && open ../docs/build/html/index.html

docs:
	cd ../docs && make html

release-all: release-guides release-quickstarts operator-build-release bundle-build-ocp-release bundle-build-k8s-release

release-guides: generate-guides
	rm -rf ${GUIDES_BASE_DIR}
	cp -r ${GUIDES_BUILD_BASE_DIR} ${GUIDES_BASE_DIR}

release-quickstarts: generate-quickstarts
	rm -rf ${QUICKSTARTS_BASE_DIR}
	cp -r ${QUICKSTARTS_BUILD_BASE_DIR} ${QUICKSTARTS_BASE_DIR}

generate-all: generate-guides generate-quickstarts

generate-guides: generate-guide-ocp3-manual generate-guide-ocp3-olm generate-guide-ocp4-manual generate-guide-ocp4-olm generate-guide-k8s-manual generate-guide-k8s-olm


generate-guide-ocp3-manual:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	cp ../deploy/common/service-account.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	cp ../deploy/common/role.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	cp ../deploy/common/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	cp ../deploy/common/deployment.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/manual
	cp ../deploy/crds/argoproj.io_argocds_crd.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/manual/crd.yaml
	echo "---" >> ${GUIDES_BUILD_BASE_DIR}/ocp3/manual/role-binding.yaml
	cat ../deploy/ocp3/role-binding.yaml >> ${GUIDES_BUILD_BASE_DIR}/ocp3/manual/role-binding.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ../deploy/common/deployment.yaml > ${GUIDES_BUILD_BASE_DIR}/ocp3/manual/deployment.yaml

generate-guide-ocp3-olm:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	cp ../deploy/common/operator-group.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	cp ../deploy/ocp3/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	cp ../deploy/ocp3/catalog-source.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	cp ../deploy/ocp3/subscription.yaml ${GUIDES_BUILD_BASE_DIR}/ocp3/olm
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ../deploy/ocp3/catalog-source.yaml > ${GUIDES_BUILD_BASE_DIR}/ocp3/olm/catalog-source.yaml

generate-guide-ocp4-manual:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	cp ../deploy/common/service-account.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	cp ../deploy/common/role.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	cp ../deploy/common/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	cp ../deploy/common/deployment.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/manual
	cp ../deploy/crds/argoproj.io_argocds_crd.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/manual/crd.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ../deploy/common/deployment.yaml > ${GUIDES_BUILD_BASE_DIR}/ocp4/manual/deployment.yaml

generate-guide-ocp4-olm:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/ocp4/olm
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/ocp4/olm
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/olm
	cp ../deploy/common/operator-group.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/olm
	cp ../deploy/ocp4/catalog-source.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/olm
	cp ../deploy/ocp4/subscription.yaml ${GUIDES_BUILD_BASE_DIR}/ocp4/olm
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ../deploy/ocp4/catalog-source.yaml > ${GUIDES_BUILD_BASE_DIR}/ocp4/olm/catalog-source.yaml

generate-guide-k8s-manual:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	cp ../deploy/common/service-account.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	cp ../deploy/common/role.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	cp ../deploy/common/role-binding.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	cp ../deploy/common/deployment.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/manual
	cp ../deploy/crds/argoproj.io_argocds_crd.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/manual/crd.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ../deploy/common/deployment.yaml > ${GUIDES_BUILD_BASE_DIR}/k8s/manual/deployment.yaml

generate-guide-k8s-olm:
	rm -rf ${GUIDES_BUILD_BASE_DIR}/k8s/olm
	mkdir -p ${GUIDES_BUILD_BASE_DIR}/k8s/olm
	cp ../deploy/common/namespace.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/olm
	cp ../deploy/common/operator-group.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/olm
	cp ../deploy/k8s/catalog-source.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/olm
	cp ../deploy/k8s/subscription.yaml ${GUIDES_BUILD_BASE_DIR}/k8s/olm
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ../deploy/k8s/catalog-source.yaml > ${GUIDES_BUILD_BASE_DIR}/k8s/olm/catalog-source.yaml

operator-build-dev:
	export GO111MODULE=on
	cd ../ && operator-sdk build ${REGISTRY_DEV}/${NAMESPACE}/${NAME}:v${VERSION}
	
operator-push-dev:
	docker push ${REGISTRY_DEV}/${NAMESPACE}/${NAME}:v${VERSION}


operator-build-release:
	export GO111MODULE=on
	cd ../ && operator-sdk build ${REGISTRY}/${NAMESPACE}/${NAME}:v${VERSION}

bundle-verify-ocp-release:
	operator-courier --verbose verify ${BUNDLE_MANIFEST_BASE_DIR}/ocp/${NAME}

bundle-build-ocp-release: bundle-verify-ocp-release
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/release/ocp
	cp -r ${BUNDLE_DIR}/* ${BUNDLE_BUILD_BASE_DIR}/release/ocp/
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests
	cp -r ${BUNDLE_MANIFEST_BASE_DIR}/ocp/${NAME} ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	sed 's/${REGISTRY_DEV}/${REGISTRY}/g' ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	docker build -t ${REGISTRY}/${NAMESPACE}/${NAME}-registry-ocp:${VERSION} ${BUNDLE_BUILD_BASE_DIR}/release/ocp
	cp -r ${BUNDLE_BUILD_BASE_DIR}/release/ocp/manifests/${NAME} ../deploy/operatorhubs/ocp
#	rm -rf ${BUNDLE_BUILD_BASE_DIR}/release/ocp

bundle-push-ocp-release:
	docker push ${REGISTRY}/${NAMESPACE}/${NAME}-registry-ocp:${VERSION}

bundle-verify-ocp-dev:
	operator-courier --verbose verify ${BUNDLE_MANIFEST_BASE_DIR}/ocp/${NAME}

bundle-build-ocp-dev: bundle-verify-ocp-dev
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}-ocp
	cp -r ${BUNDLE_DIR}/* ${BUNDLE_BUILD_BASE_DIR}-ocp/
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}-ocp/manifests
	cp -r ${BUNDLE_MANIFEST_BASE_DIR}/ocp/${NAME} ${BUNDLE_BUILD_BASE_DIR}-ocp/manifests/
	docker build -t ${REGISTRY_DEV}/${NAMESPACE}/${NAME}-registry-ocp:${VERSION} ${BUNDLE_BUILD_BASE_DIR}-ocp/
	#rm -rf ${BUNDLE_BUILD_BASE_DIR}-ocp

bundle-push-ocp-dev:
	docker push ${REGISTRY_DEV}/${NAMESPACE}/${NAME}-registry-ocp:${VERSION}

bundle-verify-k8s-release:
	operator-courier --verbose verify --ui_validate_io ${BUNDLE_MANIFEST_BASE_DIR}/k8s/${NAME}

bundle-build-k8s-release: bundle-verify-k8s-release
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/release/k8s
	cp -r ${BUNDLE_DIR}/* ${BUNDLE_BUILD_BASE_DIR}/release/k8s/
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests
	cp -r ${BUNDLE_MANIFEST_BASE_DIR}/k8s/${NAME} ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/
	sed 's/${REGISTRY}/${REGISTRY}/g' ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/0.0.4/_argocd-operator-helm.v0.0.4.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/0.0.4/argocd-operator-helm.v0.0.4.clusterserviceversion.yaml
	sed 's/${REGISTRY}/${REGISTRY}/g' ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml > ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	rm ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	mv ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/${VERSION}/_argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME}/${VERSION}/argocd-operator-helm.v${VERSION}.clusterserviceversion.yaml
	docker build -t ${REGISTRY}/${NAMESPACE}/${NAME}-registry-k8s:${VERSION} ${BUNDLE_BUILD_BASE_DIR}/release/k8s
	cp -r ${BUNDLE_BUILD_BASE_DIR}/release/k8s/manifests/${NAME} ../deploy/operatorhubs/k8s
#	rm -rf ${BUNDLE_BUILD_BASE_DIR}/release/k8s

bundle-push-k8s-release:
	docker push ${REGISTRY}/${NAMESPACE}/${NAME}-registry-k8s:${VERSION}

bundle-verify-k8s-dev:
	operator-courier --verbose verify --ui_validate_io ${BUNDLE_MANIFEST_BASE_DIR}/k8s/${NAME}

bundle-build-k8s-dev: bundle-verify-k8s-dev
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}-k8s
	cp -r ${BUNDLE_DIR}/* ${BUNDLE_BUILD_BASE_DIR}-k8s/
	mkdir -p ${BUNDLE_BUILD_BASE_DIR}-k8s/manifests
	cp -r ${BUNDLE_MANIFEST_BASE_DIR}/k8s/${NAME} ${BUNDLE_BUILD_BASE_DIR}-k8s/manifests/
	docker build -t ${REGISTRY_DEV}/${NAMESPACE}/${NAME}-registry-k8s:${VERSION} ${BUNDLE_BUILD_BASE_DIR}-k8s/
	#rm -rf ${BUNDLE_BUILD_BASE_DIR}-k8s

bundle-push-k8s-dev:
	docker push ${REGISTRY_DEV}/${NAMESPACE}/${NAME}-registry-k8s:${VERSION}

