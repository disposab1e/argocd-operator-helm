#!/usr/bin/env bash
set -e

# Works in local, github, travisci and circleci environments :-)
cd build/

# Lint Helm chart
make helm-templates

# Build operator with operator-sdk
make operator-build-ci

# Generate bundles 
make bundle-generate-k8s-ci
make bundle-generate-ocp-ci

# Verify bundles
make bundle-verify-k8s-ci
make bundle-verify-ocp-ci

# Build bundles (registry) docker image 
make bundle-build-k8s-ci
make bundle-build-ocp-ci

# Securely login to docker.io
echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USER" --password-stdin

# Push the operator to dockerhub
make operator-push-ci

# Push bundles to docker.io
make bundle-push-ocp-ci
make bundle-push-k8s-ci

# Go back ;-)
cd ../
