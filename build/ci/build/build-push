#!/usr/bin/env bash
set -e

# Works in local, github, travisci and circleci environments :-)
cd build/

# Lint Helm chart
echo "======================================================"
echo "Linting Helm Chart"
echo "======================================================"
make helm-templates

# Build operator with operator-sdk
echo "======================================================"
echo "Build Operator"
echo "======================================================"
make operator-build-ci

# Generate bundles 
echo "======================================================"
echo "Generate Operator Bundles for k8s and ocp"
echo "======================================================"
make bundle-generate-k8s-ci
make bundle-generate-ocp-ci

# Verify bundles
echo "======================================================"
echo "Verify Operator Bundles for k8s and ocp"
echo "======================================================"
make bundle-verify-k8s-ci
make bundle-verify-ocp-ci

# Build bundles (registry) docker image 
echo "======================================================"
echo "Build Operator Bundles for k8s and ocp"
echo "======================================================"
make bundle-build-k8s-ci
make bundle-build-ocp-ci

# Securely login to docker.io
echo "======================================================"
echo "Login to docker.io"
echo "======================================================"
echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USER" --password-stdin

# Push the operator to dockerhub
echo "======================================================"
echo "Push Operator to docker.io"
echo "======================================================"
make operator-push-ci

# Push bundles to docker.io
echo "======================================================"
echo "Push Operator Bundles to docker.io"
echo "======================================================"
make bundle-push-ocp-ci
make bundle-push-k8s-ci

# Go back ;-)
cd ../
