#!/usr/bin/env bash
set -e

# Install oc Client
echo "======================================================"
echo "Installing oc Client"
echo "======================================================"
curl -Lo oc.tar.gz https://github.com/openshift/origin/releases/download/v3.11.0/openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit.tar.gz
tar xvfz oc.tar.gz
chmod +x openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/oc
chmod +x openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/kubectl
sudo mv openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/oc /usr/local/bin/
sudo mv openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/kubectl /usr/local/bin/

cat << EOF | sudo tee /etc/docker/daemon.json
{
    "insecure-registries" : [ "172.30.0.0/16" ]
}
EOF

sudo systemctl restart docker

sudo apt update
sudo apt-get install firewalld
sudo systemctl enable firewalld
sudo systemctl start firewalld
sudo firewall-cmd --state


sudo firewall-cmd --permanent --new-zone dockerc
sudo firewall-cmd --permanent --zone dockerc --add-source 172.17.0.0/16
sudo firewall-cmd --permanent --zone dockerc --add-port 8443/tcp
sudo firewall-cmd --permanent --zone dockerc --add-port 53/udp
sudo firewall-cmd --permanent --zone dockerc --add-port 8053/udp
sudo firewall-cmd --reload

#sudo apt install socat

#sudo ufw disable
sudo sysctl net.ipv4.ip_forward
sudo sysctl -w net.ipv4.ip_forward=1
sudo sysctl net.ipv4.ip_forward


mkdir -p "$HOME/.occluster"
#oc cluster up --public-hostname=$(hostname -I  | cut -d" " -f1) --routing-suffix=$(hostname -I  | cut -d" " -f1).xip.io --loglevel=5
#oc cluster up --routing-suffix="127.0.0.1.nip.io
oc cluster up --loglevel=5
#--public-hostname=127.0.0.1 --routing-suffix=127.0.0.1.xip.io --loglevel=5

# --forward-ports=true
#--base-dir="$HOME/.occluster"
#sudo oc cluster up 
