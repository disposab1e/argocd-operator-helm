#!/usr/bin/env bash
set -e

# Install oc Client
echo "======================================================"
echo "Installing oc Client"
echo "======================================================"
curl -Lo oc.tar.gz https://github.com/openshift/origin/releases/download/v3.11.0/openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit.tar.gz
tar xvfz oc.tar.gz
chmod +x openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/oc
chmod +x openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/kubectl
sudo mv openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/oc /usr/local/bin/
sudo mv openshift-origin-client-tools-v3.11.0-0cbc58b-linux-64bit/kubectl /usr/local/bin/

cat << EOF | sudo tee /etc/docker/daemon.json
{
    "insecure-registries" : [ "172.30.0.0/16" ]
}
EOF

sudo systemctl restart docker

#sudo apt update
#sudo apt install socat

sudo ufw disable
sudo sysctl net.ipv4.ip_forward
sudo sysctl -w net.ipv4.ip_forward=1
sudo sysctl net.ipv4.ip_forward

iptables -I INPUT 1 -p tcp --dport 8443 -j ACCEPT
iptables -I INPUT 1 -p tcp --dport 4001 -j ACCEPT
iptables -I INPUT 1 -p udp --dport 53 -j ACCEPT
iptables -I INPUT 1 -p udp --dport 8083 -j ACCEPT

mkdir -p "$HOME/.occluster"
oc cluster up --public-hostname=$(hostname -I  | cut -d" " -f2) --routing-suffix=$(hostname -I  | cut -d" " -f2).xip.io --loglevel=5
#oc cluster up --routing-suffix="127.0.0.1.nip.io
oc cluster up --public-hostname=127.0.0.1 --routing-suffix=127.0.0.1.xip.io --loglevel=5

# --forward-ports=true
#--base-dir="$HOME/.occluster"
#sudo oc cluster up 
