#!/usr/bin/env bash
set -e

eval $(minishift oc-env)

echo "Install ArgoCD operator (manual)"
oc apply -f build/_output/guides/ci/ocp3/manual/namespace.yaml
oc apply -f build/_output/guides/ci/ocp3/manual/service-account.yaml
oc apply -f build/_output/guides/ci/ocp3/manual/role.yaml
oc apply -f build/_output/guides/ci/ocp3/manual/role-binding.yaml
oc apply -f build/_output/guides/ci/ocp3/manual/crd.yaml
oc apply -f build/_output/guides/ci/ocp3/manual/deployment.yaml

echo "Wait 20s"
sleep 20

oc wait pod -n argocd -l name=argocd-operator-helm --for=condition=Ready --timeout=120s
oc rollout status -w deployment/argocd-operator-helm -n argocd

echo "Istall ArgoCD without OAuth integration"
oc apply -f examples/ocp.yaml

# oc get ArgoCDs argocd -n argocd

echo "Wait 240s for ArgoCD installation"
sleep 240

oc rollout status -w deployment/argocd-application-controller -n argocd
oc rollout status -w deployment/argocd-dex-server -n argocd
oc rollout status -w deployment/argocd-redis -n argocd
oc rollout status -w deployment/argocd-repo-server -n argocd
oc rollout status -w deployment/argocd-server -n argocd

oc get all -n argocd

echo "Remove ArgoCD installation"
oc delete ArgoCD argocd -n argocd

oc delete crd appprojects.argoproj.io
oc delete crd applications.argoproj.io
oc delete crd workflowtemplates.argoproj.io
oc delete crd workflows.argoproj.io


echo "Istall ArgoCD with OAuth integration"
oc apply -f examples/ocp-oauth.yaml

# oc get ArgoCDs argocd -n argocd

echo "Wait 240s for ArgoCD installation"
sleep 240

oc rollout status -w deployment/argocd-application-controller -n argocd
oc rollout status -w deployment/argocd-dex-server -n argocd
oc rollout status -w deployment/argocd-redis -n argocd
oc rollout status -w deployment/argocd-repo-server -n argocd
oc rollout status -w deployment/argocd-server -n argocd

oc get all -n argocd

echo "Remove ArgoCD installation"
oc delete ArgoCD argocd -n argocd

oc delete crd appprojects.argoproj.io
oc delete crd applications.argoproj.io
oc delete crd workflowtemplates.argoproj.io
oc delete crd workflows.argoproj.io

echo "ArgoCD removed"

echo "Remove ArgoCD operator"
oc delete ArgoCD argocd -n argocd

oc delete -f build/_output/guides/ci/ocp3/manual/deployment.yaml
oc delete -f build/_output/guides/ci/ocp3/manual/crd.yaml
oc delete -f build/_output/guides/ci/ocp3/manual/role-binding.yaml
oc delete -f build/_output/guides/ci/ocp3/manual/role.yaml
oc delete -f build/_output/guides/ci/ocp3/manual/service-account.yaml
oc delete -f build/_output/guides/ci/ocp3/manual/namespace.yaml

echo "ArgoCD operator removed"
