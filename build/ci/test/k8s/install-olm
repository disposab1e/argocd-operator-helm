#!/usr/bin/env bash
set -e

# Operator Lifecycle Manager
echo "======================================================"
echo "Installing Operator Lifecycle Manager ${OLM_VERSION}"
echo "======================================================"

kubectl apply -f https://github.com/operator-framework/operator-lifecycle-manager/releases/download/${OLM_VERSION}/crds.yaml
sleep 20
kubectl apply -f https://github.com/operator-framework/operator-lifecycle-manager/releases/download/${OLM_VERSION}/olm.yaml


# wait for deployments to be ready
kubectl rollout status -w deployment/olm-operator --namespace=olm
kubectl rollout status -w deployment/catalog-operator --namespace=olm

sleep 60

kubectl rollout status -w deployment/packageserver --namespace=olm

# Delete "operatorhubio-catalog" cause we provide our own catalogue
echo "======================================================"
echo "Delete Community Catalogue from operatohub.io"
echo "======================================================"
kubectl delete catalogsource operatorhubio-catalog -n olm
