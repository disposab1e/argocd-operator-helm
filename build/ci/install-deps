#!/usr/bin/env bash
set -e

#pyenv versions
#pyenv global 3.6.5

# libvirt
echo "Installing libvirt/kvm"
sudo apt-get update && sudo apt-get install -y bridge-utils libvirt-bin libvirt-dev qemu-kvm qemu-utils 


# docker-machine-driver-kvm for Minishift
echo "Installing docker-machine-driver-kvm for minishift"
sudo curl -L https://github.com/dhiltgen/docker-machine-kvm/releases/download/v0.10.0/docker-machine-driver-kvm-ubuntu16.04 -o /usr/local/bin/docker-machine-driver-kvm
sudo chmod +x /usr/local/bin/docker-machine-driver-kvm

# Normally 
# sudo usermod -a -G libvirt travis
# sudo usermod -a -G libvirt-qemu travis
# sudo usermod -a -G libvirt-dnsmasq travis
# newgrp libvirt

# Bad hack cause 'newgrp libvirt' is not working
sudo chmod 777 /var/run/libvirt/libvirt-sock*

# Show network list to see default network is running and autoconfigure is enabled
# sudo virsh net-list --all

# No need to restart
#sudo systemctl restart libvirtd
#sudo systemctl status libvirtd


# operator-courier
echo "Installing operator-courier"
pip install operator-courier
operator-courier --version

# Operator SDK
echo "Installing operator-sdk"
OPERATOR_SDK_VER=v0.15.0
curl -Lo operator-sdk https://github.com/operator-framework/operator-sdk/releases/download/${OPERATOR_SDK_VER}/operator-sdk-${OPERATOR_SDK_VER}-x86_64-linux-gnu
chmod +x operator-sdk
sudo mv operator-sdk /usr/local/bin/

# Helm
echo "Installing helm-3"
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

# kubectl
echo "Installing kubectl"
KUBECTL_VERSION="v1.14.0"
curl -Lo kubectl "https://storage.googleapis.com/kubernetes-release/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# Minikube
echo "Installing minikube"
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
chmod +x minikube
sudo mv minikube /usr/local/bin/

# Minishift
echo "Installing minishift"
MINISHIFT_VERSION="v1.34.2"
curl -Lo minishift.tgz https://github.com/minishift/minishift/releases/download/${MINISHIFT_VERSION}/minishift-${MINISHIFT_VERSION}-linux-amd64.tgz
tar xvf minishift.tgz
sudo mv minishift-${MINISHIFT_VERSION}-linux-amd64/minishift /usr/local/bin
chmod +x /usr/local/bin/minishift
